# Specification Changes Log — AST diagnostics/formatter

## Область изменений
Консолидация и фиксация изменений по рефакторингу форматировщика, навигации, диагностике и стратегии тестирования для шаблонов fte.js.

## Принципы (закреплены)
- [x] Разделение форматирования «текст шаблона» vs «инструкции шаблонизатора»
- [x] Потоковая обработка по `ast.tokens` вместо реконструкции документа
- [x] Prettier как основной форматтер: отдельные опции для текста и кода

## Изменения по компонентам

### Formatter
- [x] Новый алгоритм на базе обхода исходника и `ast.tokens` (`server/src/formatterCore.ts`: `formatWithSourceWalking`)
- [x] Группировка `text` + `expression` в единый текстовый чанк для контекстного форматирования
- [x] Форматирование кода внутри `<# ... #>` через Prettier (babel/ts) с сохранением тегов
- [x] Нормализация структурных тегов: `<#- block` → `<# block`, парные `end` теги
- [x] Директивы (`<#@ ... #>`) выносятся в начало файла/блока без отступов
- [x] Опция `htmlWhitespaceSensitivity: 'css'` для предотвращения «схлопывания» HTML
- [x] Сохранение дословных межтокенных промежутков исходного текста

Ключевые файлы:
- `server/src/formatterCore.ts` (новая реализация: `formatWithSourceWalking`, опции Prettier)
- `server/src/server.ts` (использование нового форматтера в `onDocumentFormatting`)

### Parser / AST
- [x] Встроенный парсер (`LocalParser`) используется везде, без внешних зависимостей
- [x] Возврат плоского списка токенов `ast.tokens` в порядке документа
- [x] Возврат структурных ошибок `ast.errors` для диагностики

Ключевые файлы:
- `server/src/parser.ts`
- `server/src/server.ts` (функция `parseContent`)

### Navigation (Go to Definition)
- [x] Переход по имени блока внутри `content('name')` ищет локально и в родителе
- [x] Навигация из объявления блока к родителю (если расширяет шаблон)
- [ ] Вынесение логики в чистую функцию `resolveDefinition(...)` и отказ от RegExp в пользу прямого AST-доступа (запланировано)

Ключевые файлы:
- `server/src/server.ts` (`connection.onDefinition`)

### Diagnostics
- [x] Отключены подсказки по trimming для структурных тегов (`block`, `slot`, `end`)
- [x] Диагностика ошибок парсера (`ast.errors`)
- [x] Ошибка при отсутствии родительского шаблона из `<#@ extend ... #>`
- [x] Предупреждения для неизвестных `content('name')` и `partial(..., 'alias')`

Ключевые файлы:
- `server/src/server.ts` (`computeDiagnostics`)

### Testing strategy
- [x] E2E-тесты с проверкой полного совпадения результата форматирования (`toBe()`)
- [x] Тесты на навигацию/диагностику (ядро логики)

Ключевые файлы (примеры):
- `server/__tests__/formatter-*.test.js`
- `server/__tests__/diagnostics-*.test.js`
- `server/__tests__/parser-integration.test.js`

### Документация
- [x] Обновления в `BUGS.md` и `MUST_HAVE.md` под выполненные изменения
- [x] Зафиксированы новые правила и архитектурные решения

## Текущее состояние выполнения
- **Formatter**: [x] внедрено
- **Parser/AST**: [x] внедрено
- **Navigation**: [~] работает, но требуется вынос логики в `resolveDefinition()` и отказ от RegExp на этапах определения — см. TODO
- **Diagnostics**: [x] внедрено
- **Testing**: [x] внедрено
- **Docs**: [x] обновлены

## TODO / Follow-ups
- [ ] Вынести навигацию в `resolveDefinition(doc, text, offset, ast)` и использовать прямые обращения к `ast.blocks`/родителю без RegExp
- [ ] Расширить тесты навигации: child → parent, multiple blocks, `content()` без имени (возврат null)
- [ ] Синхронизировать опции форматтера с пользовательскими настройками (`serverSettings.format.textFormatter` по умолчанию вкл. для `.nhtml/.nmd`)
- [ ] Ревизия TextMate-грамматики для устойчивой подсветки `#{...}` после форматирования

## Примечания по реализации
- Prettier-конфиг подхватывается через `prettier.resolveConfigSync` при наличии файла в проекте; критичные флаги выставляются явно в коде форматтера
- Поддерживается ограничение последовательных пустых строк `keepBlankLines`
