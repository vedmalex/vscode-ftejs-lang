### **Фаза: CODE_REVIEW (Анализ Соответствия)**

Ниже представлен детальный отчет о соответствии текущей реализации кода вашим спецификациям.

---
`memory-bank/tasks/2025-08-11_TASK-001_formatter-refactoring-and-bug-fixes/code-review.md`

```markdown
# Отчет о Соответствии Кода Спецификации

## 1. Обзор

Проведен анализ кодовой базы на предмет реализации требований по исправлению багов форматирования, улучшению парсера, навигации и диагностики. В целом, **большинство критических проблем решены**, но есть несколько отклонений и областей для улучшения.

## 2. Анализ по Компонентам

### 2.1. Локальный Парсер (`server/src/parser.ts`)

**Требования:**
1.  **Вывод ошибок:** Парсер должен собирать ошибки (незакрытые блоки, несопоставленные `end`) и предоставлять их в результате.
2.  **Плоский поток токенов:** Парсер должен генерировать плоский список всех токенов (`ast.tokens`) в порядке их следования в документе для надежного форматирования.

**Анализ:**
*   **Вывод ошибок:**
    *   `✅` **Compliant.** Парсер в методе `process()` теперь корректно использует стек для отслеживания открытых/закрытых блоков и слотов. Обнаруженные ошибки (unmatched end, unclosed block/slot) добавляются в массив `this.errors`, который затем присваивается `content.errors`.
    *   **Reference:** `server/src/parser.ts:442-452`, `server/src/parser.ts:466-472`.
*   **Плоский поток токенов:**
    *   `✅` **Compliant.** Парсер теперь создает и наполняет массив `tokens` всеми типами узлов (`blockStart`, `blockEnd`, `directive`, `text`, `code` и т.д.) в том порядке, в котором они встречаются. Этот массив присваивается `(content as any).tokens`.
    *   **Reference:** `server/src/parser.ts:391`, `server/src/parser.ts:401-464`.

### 2.2. Форматировщик (`server/src/formatterCore.ts` и `server/src/server.ts`)

**Требования:**
1.  **Исправление удаления блоков:** Форматировщик не должен удалять или искажать блоки и директивы.
2.  **Исправление "схлопывания" HTML:** HTML-текст не должен сжиматься в одну строку.
3.  **Раздельное форматирование:** Текст шаблона и инструкции должны форматироваться по разным правилам.
4.  **`#{...}` как часть текста:** Выражения должны форматироваться в контексте окружающего текста.
5.  **Директивы вверху блока:** Директивы `<#@...#>` должны быть вверху и без отступов.
6.  **Контент блока без отступа:** Содержимое блоков не должно получать дополнительный отступ от форматтера.
7.  **Нормализация `<#- block`:** Конструкции с trimming должны нормализоваться.

**Анализ:**
*   **Исправление удаления блоков:**
    *   `✅` **Compliant.** `onDocumentFormatting` в `server.ts` теперь использует `ast.tokens`, который содержит все структурные элементы. Новый алгоритм `formatWithSourceWalking` в `formatterCore.ts` итерирует по этому потоку, сохраняя все токены, включая блоки и директивы. **Это решает основную проблему удаления контента.**
    *   **Reference:** `server/src/server.ts:1098-1100`, `server/src/formatterCore.ts:153-228`.
*   **Исправление "схлопывания" HTML:**
    *   `⚠️` **Partially Compliant.** Проблема решена путем **полного отключения** форматирования для текстовых сегментов. В `server.ts:1071` (`getPrettierOpts`) возвращается `null`. Хотя это предотвращает баг, это не соответствует требованию "форматировать по правилам языка".
    *   **Recommendation:** Включить текстовый форматировщик, но с правильными опциями Prettier. В `getHtmlPrettierOpts` (`formatterCore.ts:12`) уже есть `htmlWhitespaceSensitivity: 'css'`, что является правильным решением. Нужно просто включить вызов этой функции.
*   **Раздельное форматирование:**
    *   `✅` **Compliant.** Логика в `formatWithSourceWalking` четко разделяет обработку: `text` и `expression` накапливаются в `textBuffer`, а `code` форматируется отдельно через `formatCodeContent`.
    *   **Reference:** `server/src/formatterCore.ts:171-198`.
*   **`#{...}` как часть текста:**
    *   `✅` **Compliant.** Токены типа `expression` теперь обрабатываются так же, как и `text`, добавляясь в `textBuffer` для совместного форматирования.
    *   **Reference:** `server/src/formatterCore.ts:186-191`.
*   **Директивы вверху блока:**
    *   `❌` **Non-Compliant.** Текущая реализация **не перемещает** директивы. Она просто сохраняет их на своих местах. Для реализации этого требования нужен более сложный алгоритм, который анализирует структуру блоков и переупорядочивает токены.
*   **Контент блока без отступа:**
    *   `✅` **Compliant.** Алгоритм `formatWithSourceWalking` не добавляет дополнительного отступа к содержимому блоков. Отступы сохраняются из оригинального текста.
*   **Нормализация `<#- block`:**
    *   `❌` **Non-Compliant.** Нормализация не реализована. `formatWithSourceWalking` выводит `rawToken` для `blockStart` как есть, без изменений.
    *   **Reference:** `server/src/formatterCore.ts:208-213`.

### 2.3. Диагностика и Навигация (`server/src/server.ts`)

**Требования:**
1.  **Диагностика ошибок парсера:** Сервер должен отображать ошибки из `ast.errors`.
2.  **Диагностика ненайденных `extend`:** Ошибка, если родительский шаблон не найден.
3.  **Корректная навигация по `content('name')`:** Переход к правильному блоку, в том числе в родительском файле.

**Анализ:**
*   **Диагностика ошибок парсера:**
    *   `✅` **Compliant.** `computeDiagnostics` теперь итерирует по `ast.errors` и создает LSP-диагностики.
    *   **Reference:** `server/src/server.ts:446-451`.
*   **Диагностика ненайденных `extend`:**
    *   `✅` **Compliant.** В `computeDiagnostics` есть блок "Validate extend directive", который вызывает `resolveTemplatePath` и создает ошибку, если путь не разрешается.
    *   **Reference:** `server/src/server.ts:600-622`.
*   **Корректная навигация по `content('name')`:**
    *   `✅` **Compliant.** `onDefinition` корректно ищет блок по имени сначала в `ast.blocks` текущего файла, а затем, при неудаче, в родительском шаблоне.
    *   **Reference:** `server/src/server.ts:806-838`.

### 2.4. Документация (`BUGS.md`, `MUST_HAVE.md`)

**Требования:**
1.  Добавить информацию об ошибках парсера, правилах форматирования и навигации.

**Анализ:**
*   `⚠️` **Partially Compliant.** Файлы были обновлены, но не содержат всех последних принятых решений. Например, `BUGS.md` не описывает баг с удалением блоков, а `MUST_HAVE.md` не полностью отражает новые правила форматирования.
*   **Recommendation:** Провести полную синхронизацию документации с последними изменениями.

## 3. Итоги и Рекомендации

Проделана огромная работа, и **самые критические баги (удаление контента, ошибки парсера, навигация) исправлены**. Новый алгоритм форматирования на основе потока токенов является гораздо более надежным.

**Рекомендации для следующих шагов:**
1.  **Включить текстовый форматировщик:** Активировать `textFormatter` для HTML, так как правильная опция (`htmlWhitespaceSensitivity: 'css'`) уже есть. Это вернет форматирование HTML без "схлопывания".
2.  **Реализовать перемещение директив:** Доработать `formatWithSourceWalking` для определения границ блоков и перемещения директив в их начало.
3.  **Реализовать нормализацию `<#- block`:** Добавить логику в `formatWithSourceWalking` для приведения `<#- block` к `<# block`.
4.  **Синхронизировать документацию:** Обновить `MUST_HAVE.md` и `BUGS.md` для отражения всех последних исправлений и принятых решений.```